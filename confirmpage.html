<!DOCTYPE html>
<html>

<head>
    <title>concertpage</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.slim.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="css/style.css">
</head>

<body background="images/confirmpage.png" style="background-repeat: no-repeat;">
    <div class="container-fluid confirm" style="margin-left:-16em;">
        <div class="row" style="margin-left: 15em;">
            <span id="massage" style="font-size: xx-large;font-weight: bold; margin-left: 32.5%;"></span>
            <div class="col-md-offset-3 offset-sm-5  ">
                <a class="a_tag" href="#" onclick="confirmbtn()"><button type="button"
                        class="btn btn-primary btn-lg btn1">Oui</button>
            </div>
            <div class="col-md-offset-3 offset-sm-0 ">
                <a class="a_tag" href="#" onclick="conirmbtnNo()"><button type="button"
                        class="btn btn-primary  btn-lg btn1">Non</button>
            </div>
        </div>
    </div>


    <script>
        function getBrowserDetails() {
            const userAgent = navigator.userAgent;
            let browserName, fullVersion, majorVersion;
            let nameOffset, verOffset, ix;

            // In Opera, the true version is after "Opera" or after "Version"
            if ((verOffset = userAgent.indexOf("Opera")) !== -1) {
                browserName = "Opera";
                fullVersion = userAgent.substring(verOffset + 6);
                if ((verOffset = userAgent.indexOf("Version")) !== -1)
                    fullVersion = userAgent.substring(verOffset + 8);
            }
            // In MSIE, the true version is after "MSIE" in userAgent
            else if ((verOffset = userAgent.indexOf("MSIE")) !== -1) {
                browserName = "Microsoft Internet Explorer";
                fullVersion = userAgent.substring(verOffset + 5);
            }
            // In Chrome, the true version is after "Chrome"
            else if ((verOffset = userAgent.indexOf("Chrome")) !== -1) {
                browserName = "Chrome";
                fullVersion = userAgent.substring(verOffset + 7);
            }
            // In Safari, the true version is after "Safari" or after "Version"
            else if ((verOffset = userAgent.indexOf("Safari")) !== -1) {
                browserName = "Safari";
                fullVersion = userAgent.substring(verOffset + 7);
                if ((verOffset = userAgent.indexOf("Version")) !== -1)
                    fullVersion = userAgent.substring(verOffset + 8);
            }
            // In Firefox, the true version is after "Firefox"
            else if ((verOffset = userAgent.indexOf("Firefox")) !== -1) {
                browserName = "Firefox";
                fullVersion = userAgent.substring(verOffset + 8);
            }
            // In most other browsers, "name/version" is at the end of userAgent
            else if ((nameOffset = userAgent.lastIndexOf(' ') + 1) <
                (verOffset = userAgent.lastIndexOf('/'))) {
                browserName = userAgent.substring(nameOffset, verOffset);
                fullVersion = userAgent.substring(verOffset + 1);
                if (browserName.toLowerCase() === browserName.toUpperCase()) {
                    browserName = navigator.appName;
                }
            }

            // Trimming the fullVersion string at the semicolon/space if present
            if ((ix = fullVersion.indexOf(";")) !== -1)
                fullVersion = fullVersion.substring(0, ix);
            if ((ix = fullVersion.indexOf(" ")) !== -1)
                fullVersion = fullVersion.substring(0, ix);

            majorVersion = parseInt('' + fullVersion, 10);
            if (isNaN(majorVersion)) {
                fullVersion = '' + parseFloat(navigator.appVersion);
                majorVersion = parseInt(navigator.appVersion, 10);
            }

            return {
                browserName: browserName,
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                pageName: 'pack',
                msisdn: params.get('number')
            };
        }
        window.onload = async function validateToken() {

            // URL of the API endpoint
            const validateTokenUrl = '/validate-token'; // Replace with your actual API URL

            const token = localStorage.getItem('token')
            // Data to send in the request body
            const data = {
                token: token
            };

            // Configuration for the fetch request
            const requestOptions = {
                method: 'POST', // HTTP method
                headers: {
                    'Content-Type': 'application/json' // Specify content type
                },
                body: JSON.stringify(data) // Convert data to JSON string
            };

            // Make the fetch request
            fetch(validateTokenUrl, requestOptions)
                .then(response => {
                    if (!response.ok) {
                        window.location.href = "/index"
                    }
                    return true; // Parse JSON response
                })
                .then(data => {
                    return true; // Parse JSON response
                    // Handle success response here
                })
                .catch(error => {
                    console.error('Error:', error);
                    window.location.href = "/index"
                    // Handle error here
                });

            // Save analytics Data
            fetch('/analytic', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': localStorage.getItem('token')
                },
                body: JSON.stringify(details)
            })
                .then(response => {
                    if (response.ok) {
                        console.log('Data saved successfully');
                        // Optionally, perform any action on successful save
                    } else {
                        console.error('Failed to save data');
                    }
                })
                .catch(error => {
                    debugger;
                    console.error('Error:', error);
                });
        }

        const params = new URLSearchParams(window.location.search)
        if (!params.has('number') || !params.has('pack') || !params.has('service') || !params.has('promoName')) {
            window.location.href = "/index";
        }
        var service = params.get('service');
        var pack = params.get('pack');
        var promoName = params.get('promoName');

        if (service == 'karaoke' && pack == 1 && promoName == 'kimia') {
            document.getElementById("massage").innerHTML = "Abonnez-vous au plan quotidien @ 40XAF ";

        } else if (service == 'karaoke' && pack == 2 && promoName == 'kimia') {
            document.getElementById("massage").innerHTML = "Abonnez-vous au plan hebdomadaire @ 175XAF ";

        }
        // else if (service == 'karaoke' && pack == 3 && promoName =='kimia'){
        //     document.getElementById("massage").innerHTML = "Veuillez confirmer votre abonnement Mobile Karaoke plan mensuel @ 300xaf ";

        // }

        // else if (service == 'mashup' && pack == 1 && promoName =='kimia'){
        //     document.getElementById("massage").innerHTML = "Veuillez confirmer votre abonnement Mash up plan quotidien @ 30xaf ";

        // } else if (service == 'mashup' && pack == 2 && promoName =='kimia'){
        //     document.getElementById("massage").innerHTML = "Veuillez confirmer votre abonnement Mash up plan hebdomadaire @ 100xaf ";

        // } else if (service == 'concert' && pack == 1 && promoName =='kimia'){
        //     document.getElementById("massage").innerHTML = "Veuillez confirmer votre abonnement Concerts plan quotidien @ 40 xaf ";

        // } else if (service == 'concert' && pack == 2 && promoName =='kimia'){
        //     document.getElementById("massage").innerHTML = "Veuillez confirmer votre abonnement Concerts plan quotidien @ hebdomadaire @ 150xaf ";

        // } 

        //   $.ajax({
        //    url: "http://mtncm.mobbilewap.com/camroon/sendsms", 
        //    type: "POST",
        //    dataType: "json",
        //    contentType: "application/json",
        //    data: JSON.stringify({
        //                     msisdn: params.get('number'),
        //                     message: 'En cliquant sur le bouton de confirmation sur la page web vous validez votre abonnement au service Mobile Karaoke',

        //                 }),
        //                 success: function (result) {
        //     console.log("result is",result);

        //     },
        // });

        confirmbtn();
    
        function confirmbtn() {
            const params = new URLSearchParams(window.location.search);
            $(".a_tag").addClass("disable-click");

            var packName = params.get('pack');
            // if (params.get('pack') == 1) {
            //     packName = "daily";
            // } else {
            //     packName = "weekly";
            // }

            $.ajax({
                url: "http://mobbilewap.mtncongo.net:8080/congo/fmradiosubunsubapi",
                type: "POST",
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({
                    msisdn: params.get('number'),
                    packName: packName,
                    renewflag: 1,
                    subunsubFlag: "S",
                    // serviceName: params.get('service'),
                    submode: "WAP",
                    promoName: promoName,
                    promoId: params.get('clickId') ? params.get('clickId') : "637637678"                    //"637637678"
                }),
                // success: function (result) {
                //     console.log(result);
                //     window.location.href = "/Thankyou?clickId=" + params.get('clickId');
                // },
                // error: function (err) {
                //     console.log("error is", err);
                //     window.location.href = "/index"

                // }
                success: function (result) {
                    if (result.status === 200) {
                        // Request Submitted
                        window.location.href = "/Thankyou?clickId=" + params.get('clickId');
                    } else if (result.status === 201) {
                        // Already active
                        alert("Already active");
                        // Handle this case as needed
                    } else {
                        // Unexpected success status, handle it accordingly
                        console.log("Unexpected success status:", result.status);
                    }
                },
                error: function (err) {
                    console.log("error is", err);
                    if (err.status === 500) {
                        // Some Dynamic Error
                        alert("Some Dynamic Error");
                        // Handle this case as needed
                    } else {
                        // Other error status, handle it accordingly
                        window.location.href = "/index";
                    }
                }
            });


        }

        function conirmbtnNo() {
            window.location.href = "/"
        }   
    </script>
</body>

</html>
